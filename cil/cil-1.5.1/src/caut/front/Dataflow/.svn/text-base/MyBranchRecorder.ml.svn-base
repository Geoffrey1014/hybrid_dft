(** 
	This module is to record all branches in the file.
*)
open Cil

let dump_branches_file_name = ref "branches.txt"

type my_branch = {

	mutable my_branch_fun_name: string;
	mutable my_branch_fun_id: int;
	mutable my_branch_if_stmt_id: int;
	mutable my_branch_if_stmt_line: int;
}

let g_my_branch_list = ref([]: my_branch list)

(* file format 
  fun_name fun_id if_stmt_id if_stmt_line
*)
let dump_my_branch_list (branch_list: my_branch list) (filename: string) =

	let dump_channel = open_out filename in
    List.iter 
		begin fun item -> 
			output_string dump_channel item.my_branch_fun_name;
			output_string dump_channel " ";
			output_string dump_channel (string_of_int item.my_branch_fun_id);
			output_string dump_channel " ";
			output_string dump_channel (string_of_int item.my_branch_if_stmt_id);
			output_string dump_channel " ";
			output_string dump_channel (string_of_int item.my_branch_if_stmt_line);
			output_string dump_channel "\n";
		    flush dump_channel
		end
	  branch_list
;;

class myBranchVisitor (func: Cil.fundec) = object(self)
	inherit nopCilVisitor
	
	method vstmt st = 
		match st.skind with
		| If(e,b1,b2,loc) ->
			let item = {my_branch_fun_name=func.svar.vname;
					    my_branch_fun_id = func.svar.vid;
					   	my_branch_if_stmt_id = st.sid;
					   	my_branch_if_stmt_line = loc.line
					   	} in
		    g_my_branch_list := !g_my_branch_list @ [item];
		    DoChildren
		| _ -> DoChildren
end;;

let do_record_branch (file: Cil.file) =
	List.iter
		begin fun g ->
			match g with
			| GFun(func, loc) ->	
				ignore (Cil.visitCilFunction (new myBranchVisitor func) func);
			| _ -> ()
		end
	  file.globals;
    let dump_file_name = file.fileName ^ "." ^ !dump_branches_file_name in 
	dump_my_branch_list !g_my_branch_list dump_file_name
;;

let feature : featureDescr = 
  { fd_name = "branch";              
    fd_enabled = ref false;
    fd_description = "recording all branches in the file";
    fd_extraopt = [ ];
    fd_doit = 
    (function (f: file) -> 
      do_record_branch f);
    fd_post_check = true
  }
